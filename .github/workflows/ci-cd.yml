name: CI/CD - Backend Deploy

on:
  push:
    branches:
      - main

env:
  ACR_NAME: democontainerregistry123
  ACR_REPO: backend
  K8S_NAMESPACE: default

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Azure login
      - name: Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Get latest image tag from ACR
      - name: Get latest image tag
        id: gettag
        run: |
          IMAGE_TAG=$(az acr repository show-tags \
            --name $ACR_NAME \
            --repository $ACR_REPO \
            --orderby time_desc \
            --output tsv \
            --top 1)

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "✅ Latest image tag: $IMAGE_TAG"

      # 4. Update Kubernetes manifest with image + tag
      - name: Update backend-deployment.yaml
        run: |
          sed -i "s|<IMAGE>|${ACR_NAME}.azurecr.io/${ACR_REPO}:${IMAGE_TAG}|g" k8s/backend-deployment.yaml
          echo "✅ Final deployment file image line:"
          grep "image:" k8s/backend-deployment.yaml

      # 5. Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      # 6. Get AKS credentials
      - name: AKS login
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RG }} \
            --name ${{ secrets.AKS_NAME }} \
            --overwrite-existing

      # 7. Deploy to AKS
      - name: Apply manifests
        run: |
          kubectl apply -f k8s/backend-deployment.yaml -n $K8S_NAMESPACE
          kubectl apply -f k8s/backend-service.yaml -n $K8S_NAMESPACE
